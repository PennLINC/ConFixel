# Walkthrough for fixel-wise data conversion

For fixel-wise data, we use converter `ConFixel` to convert between fixel-wise data format `.mif` and the HDF5 file format (`.h5`) that ModelArray uses. At this point, we expect you have followed the [Installation guide](../README.md#installation) and installed `ConFixel` software and dependent software `MRtrix` which is needed for fixel-wise data.

## Prepare data
To convert (a list of) fixel-wise data from .mif format to .h5 format, you need to prepare a cohort CSV file that provides several basic informations of all .mif files you want to include. We recommend that, for each scalar (e.g. FD/FC/FDC), prepare one .csv file, and thus getting one .h5 file.

### Cohort's csv file (for each scalar)
Each row of a cohort .csv is for one mif file you want to include. The file should at least include these columns (Notes: these column names are fixed, i.e. not user-defined):

* "scalar_name": which tells us what metric is being analyzed, e.g. FD, FC, or FDC 
* "source_file": which tells us which mif file will be used for this subject

### Example
#### Example **folder structure**:

```
/home/username/myProject/data
|
├── cohort_FD.csv   
│
├── FD
│   ├── index.mif
│   ├── directions.mif
|   ├── sub-01_fd.mif
|   ├── sub-02_fd.mif
|   ├── sub-03_fd.mif
│   ├── ...
│
├── FC
│   ├── index.mif
│   ├── directions.mif
|   ├── sub-01_fc.mif
|   ├── sub-02_fc.mif
|   ├── sub-03_fc.mif
|   ├── ...
└── ...
```
These mif files are generated by `MRtrix`.

#### Corresponding **csv file for scalar FD** can look like this:
"cohort_FD.csv":
| ***scalar_name*** | ***source_file***  | subject_id    | age    | sex     | 
| :----:        | :----:         | :----:        | :----: |  :----: |
| FD            | FD/sub-01_fd.mif | sub-01          | 10     | F       |
| FD            | FD/sub-02_fd.mif | sub-02          | 20     | M       |
| FD            | FD/sub-03_fd.mif | sub-03          | 15     | F       |
| ...            | ... | ...          | ...     | ...       |

Notes:
* Columns that must be included are highlighted in ***bold and italics***;
* The order of columns can be changed.

For this case, when running ConFixel creating hdf5 fixel-wise data, argument **--relative-root** should be "/home/username/myProject/data" 


## Run ConFixel
### Convert .mif files to an HDF5 (.h5) file
Using above described scenario as an example, for FD dataset:
``` console
# first, activate conda environment with `conda activate <env_name>`
confixel \
    --index-file FD/index.mif \
    --directions-file FD/directions.mif \
    --cohort-file cohort_FD.csv \
    --relative-root /home/username/myProject/data \
    --output-hdf5 FD.h5
```
<!-- ^ above is tested -->

Now you should get the HDF5 file "FD.h5" in folder "/home/username/myProject/data". You may use [ModelArray](https://pennlinc.github.io/ModelArray/) to perform statistical analysis.

### Convert result .h5 file to .mif files:
After running `ModelArray` and getting statistical results in FD.h5 file (say, the analysis name is called "mylm"), you can use `fixelstats_write` to convert results into a list of .mif files in a folder specified by you. This command will also copy the original index.mif and directions.mif to this folder.
``` console 
# first, activate conda environment with `conda activate <env_name>`
fixelstats_write \
    --index-file FD/index.mif \
    --directions-file FD/directions.mif \
    --cohort-file cohort_FD.csv \
    --relative-root /home/username/myProject/data \
    --analysis-name mylm \
    --input-hdf5 FD.h5 \
    --output-dir FD_stats 
```
Now you can view the results in folder "FD_stats" in `mrview`.

> ⚠️ ⚠️ WARNING ⚠️ ⚠️ : If there are existing images in the `--output-dir`, those existing images won't be overwritten! See [notes regarding "Existing output folder and output images"](#existing-output-folder-and-output-images) for more.

### For additional description:
You can refer to `--help` for additional information:
``` console 
confixel --help
fixelstats_write --help
```

<!--TODO: after update please test out: use conda + terminal command `confixel` and `fixelstats_write`; Still using case above as an example -->
<!-- fixelstats_write: can be tested out with existing results; otherwise have to run for all fixels.. -->

<!-- TODO: also update example*.py and .sh -->

## Other notes
### ConFixel: convert from `.h5` to `.mif`
#### Existing output folder and output images
* If there are existing images in the output folder and they have the same filenames as those to be saved, the existing images won't be overwritten. This is because in function `confixel.fixels.nifti2_to_mif()`, we did not turn on `-force` in `mrconvert` (i.e., output files won't be overwritten).
* In addition, if the output folder already exists, `ConFixel` will not delete it and create a new one. Therefore, any existing files in the output folder will be kept as it is. 
* So, if the output folder already exists, you might consider deleting it before using `ConFixel` to save new images.
